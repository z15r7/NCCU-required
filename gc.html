<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>畢業學分儀表板 (Vue Version)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Outfit:wght@400;500;700&display=swap');

        :root {
            --c-primary: #7188b4; 
            --c-text-main: #616161; 
            --c-text-sub: #aeaeb2; 
            --c-bg: #f3f4f6;
        }
        
        /* 原則最佳化：
           1. 設定 width: 100% 確保寬度基準正確。
           2. 設定 overflow-x: hidden 強制禁止因負邊距(-margin)產生的水平捲動。
        */
        body { 
            font-family: "Outfit", "Noto Sans TC", sans-serif; 
            background-color: var(--c-bg); 
            margin: 0; 
            width: 100%;
            overflow-x: hidden;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .text-main { color: var(--c-text-main); } .text-sub { color: var(--c-text-sub); } .text-primary { color: var(--c-primary); }
        .text-inverse-main { color: var(--c-bg); } .text-inverse-sub { color: var(--c-bg); opacity: 0.8; }
        .bg-primary { background-color: var(--c-primary); } .bg-main { background-color: var(--c-text-main); }
        
        .neumorph-card, .neumorph-card-primary {
            background: var(--c-bg); border-radius: 1rem;
        }
        .neumorph-card {
            box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.2), -6px -6px 12px rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
        }
        .neumorph-card-primary {
            box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.2), -6px -6px 12px rgba(255, 255, 255, 0.2);
            border: 2px solid var(--c-primary);
        }

        .accordion-container {
            border-radius: 1rem; overflow: hidden; position: relative;
        }
        .shadow-layer-header {
            background-color: var(--c-bg); z-index: 30; position: relative;
            border-radius: 1rem 1rem 0 0;
            box-shadow: 
                inset 4px 4px 8px rgba(163, 177, 198, 0.4), 
                inset -2px 0 4px rgba(255, 255, 255, 0.7),
                0 6px 12px -4px rgba(163, 177, 198, 0.3);
        }
        .shadow-layer-footer {
            background-color: var(--c-bg); z-index: 20; position: relative;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 
                inset 6px 0 12px rgba(163, 177, 198, 0.3), 
                inset -6px 0px 12px rgba(255, 255, 255, 0.8), 
                inset 0px -6px 12px rgba(255, 255, 255, 0.8);
        }
        .shadow-layer-body {
            background-color: var(--c-bg); z-index: 10; position: relative;
            box-shadow: 
                inset 6px 0 12px rgba(163, 177, 198, 0.3), 
                inset -6px 0 12px rgba(255, 255, 255, 0.8), 
                inset 0 -6px 12px rgba(255, 255, 255, 0.8);
        }
        .shadow-layer-single {
            background-color: var(--c-bg); z-index: 10; position: relative;
            border-radius: 1rem;
            box-shadow: inset 6px 6px 12px rgba(163, 177, 198, 0.3), inset -6px -6px 12px rgba(255, 255, 255, 0.8);
        }

        .neumorph-btn, .neumorph-btn-active {
            background-color: var(--c-bg); transition: all 0.3s ease;
        }
        .neumorph-btn { color: var(--c-text-sub); box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.25), -5px -5px 10px rgba(255, 255, 255, 0.8); }
        .neumorph-btn:active { transform: scale(0.98); }
        .neumorph-btn-active { color: var(--c-primary); font-weight: 700; box-shadow: inset 3px 3px 6px rgba(163, 177, 198, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.8); }

        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; }
        .circle { fill: none; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }

        .tab-filter-item {
            display: grid;
            overflow: hidden; 
            transition: 
                grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-filter-item.active { grid-template-rows: 1fr; opacity: 1; }
        .tab-filter-item.inactive { grid-template-rows: 0fr; opacity: 0; pointer-events: none; }

        .category-expand-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            overflow: hidden; 
        }
        .category-expand-wrapper.open { grid-template-rows: 1fr; opacity: 1; }
        .category-expand-inner { overflow: hidden; min-height: 0; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen pb-10" style="background-color: var(--c-bg)">
            
            <div class="max-w-md mx-auto sm:max-w-xl md:max-w-5xl px-4 pt-6">
                <dashboard-header :data="data" @show-info="openInfoModal"></dashboard-header>

                <div ref="sentinelRef" class="h-px w-full absolute -translate-y-4"></div>

                <tab-navigation
                    :should-show-tabs="shouldShowTabs"
                    :is-sticky="isSticky"
                    :available-main-tabs="availableMainTabs"
                    :available-minor-tabs="availableMinorTabs"
                    :active-main-tab="activeMainTab"
                    :active-minors="activeMinors"
                    :is-double-column="isDoubleColumn"
                    :constants="CONSTANTS"
                    @set-main-tab="setMainTab"
                    @toggle-minor-tab="toggleMinorTab"
                    @toggle-layout="isDoubleColumn = !isDoubleColumn"
                    @upload-file="handleFileUpload"
                ></tab-navigation>

                <div class="mt-2 flex flex-col md:hidden">
                    <div v-for="(cat, index) in filteredCategories" 
                         :key="getOriginalIndex(cat)" 
                         class="tab-filter-item active -mx-4 px-4">
                        <div class="min-h-0">
                            <div class="py-3">
                                <category-renderer 
                                    :category="cat" 
                                    :category-index="getOriginalIndex(cat)"
                                    :is-expanded="expandedCategoryIndices.has(getOriginalIndex(cat))"
                                    :expanded-accordion-keys="expandedAccordionKeys"
                                    @show-info="openInfoModal"
                                    @toggle="toggleCategoryExpansion(getOriginalIndex(cat))"
                                    @toggle-accordion="toggleAccordionExpansion"
                                ></category-renderer>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hidden md:block transition-all duration-300" :class="isDoubleColumn ? 'mt-6' : 'mt-2'">
                    <div v-if="isDoubleColumn" class="grid grid-cols-2 gap-6 items-start">
                        <div class="flex flex-col gap-4">
                            <div v-for="(cat, index) in filteredCategories" 
                                 :key="getOriginalIndex(cat)"
                                 @click="setSelectedGlobalIndex(getOriginalIndex(cat))"
                                 class="cursor-pointer p-6 transition-all duration-300 rounded-2xl"
                                 :class="[
                                    cat.isSatisfied ? 'neumorph-card-primary' : 'neumorph-card',
                                    displayGlobalIndex === getOriginalIndex(cat) ? '' : 'hover:opacity-80'
                                 ]"
                            >
                                <category-header 
                                    :group="cat.groups[0]" 
                                    :is-open="displayGlobalIndex === getOriginalIndex(cat)" 
                                    :show-toggle="displayGlobalIndex !== getOriginalIndex(cat)" 
                                    arrow-class-name="text-sub"
                                ></category-header>
                            </div>
                        </div>

                        <div v-if="displayGlobalIndex !== -1" 
                             class="p-6" 
                             :class="data.categories[displayGlobalIndex].isSatisfied ? 'neumorph-card-primary' : 'neumorph-card'">
                            <div>
                                <category-content 
                                    :key="displayGlobalIndex"
                                    :category="data.categories[displayGlobalIndex]"
                                    :category-index="displayGlobalIndex"
                                    :expanded-accordion-keys="expandedAccordionKeys"
                                    :is-dual-column="true"
                                    @show-info="openInfoModal"
                                    @toggle-accordion="toggleAccordionExpansion"
                                ></category-content>
                            </div>
                        </div>
                        <div v-else class="neumorph-card p-6 flex items-center justify-center min-h-[200px] text-sub text-sm border-2 border-dashed border-gray-200 bg-transparent">
                            {{ CONSTANTS.LABELS.MESSAGES.NO_DATA }}
                        </div>
                    </div>

                    <div v-else class="flex flex-col">
                        <div v-for="(cat, index) in filteredCategories" :key="getOriginalIndex(cat)" class="tab-filter-item active">
                            <div class="min-h-0 p-4">
                                <category-renderer 
                                    :category="cat" 
                                    :category-index="getOriginalIndex(cat)"
                                    :is-expanded="expandedCategoryIndices.has(getOriginalIndex(cat))"
                                    :expanded-accordion-keys="expandedAccordionKeys"
                                    @show-info="openInfoModal"
                                    @toggle="toggleCategoryExpansion(getOriginalIndex(cat))"
                                    @toggle-accordion="toggleAccordionExpansion"
                                ></category-renderer>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <info-modal 
                :show="infoModal.show" 
                :messages="infoModal.messages" 
                @close="closeInfoModal"
            ></info-modal>
        </div>
    </div>

    <script>
        // Removed unused 'toRefs'
        const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

        const CONSTANTS = {
            ANIMATION_DURATION: 300,
            DEPT_KEYS: { MAJOR: "major", DOUBLE: "double", MINOR1: "minor1", MINOR2: "minor2" },
            TAB_IDS: { MAJOR: "major", MIX: "mix", DOUBLE: "double", MINOR1: "minor1", MINOR2: "minor2" },
            TAGS: { UNAVAILABLE: 'unavailable', DISABLED_SINGLE: 'disabled-to-single-major' },
            LABELS: {
                DEPT: { MAJOR: "本系", DOUBLE: "雙主修", MINOR: "輔系", MINOR1: "輔系1", MINOR2: "輔系2" },
                DASHBOARD: { APPROVED_YEAR: "核准學年", ENROLL_YEAR: "入籍學年", EARNED_CREDITS: "已修習學分" },
                TABS: { MAJOR: "本系", MIX: "本系 & 雙主修", DOUBLE: "雙主修擇一", MINOR1: "輔系1", MINOR2: "輔系2" },
                SELECT_GRADUATION: "選擇畢業方式",
                LAYOUT_TOOLTIP: { TO_SINGLE: "切換至單欄模式", TO_DOUBLE: "切換至雙欄模式" },
                MESSAGES: {
                    ERROR_CONTACT: "功能異常，請洽開發團隊",
                    ERROR_DATA: "請上傳或更新資料",
                    INFO_TITLE: "說明",
                    INFO_EMPTY: "暫無詳細說明",
                    NO_DATA: "暫無詳細課程資料"
                }
            }
        };

        const ICONS = {
            VIEWBOXES: {}, // Cleared as per optimization
            DEFS: {
                'chevron-down': { vb: '0 0 24 24', content: '<path d="m6 9 6 6 6-6"/>', stroke: true },
                'chevron-up': { vb: '0 0 24 24', content: '<path d="m18 15-6-6-6 6"/>', stroke: true },
                'chevron-right': { vb: '0 0 24 24', content: '<path d="m9 18 6-6-6-6"/>', stroke: true },
                'check': { vb: '0 0 24 24', content: '<polyline points="20 6 9 17 4 12"/>', stroke: true },
                'info': { vb: '0 0 24 24', content: '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>', stroke: true },
                'layout-grid': { vb: '0 0 24 24', content: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>', stroke: true },
                'layout-list': { vb: '0 0 24 24', content: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>', stroke: true },
                'upload': { vb: '0 0 24 24', content: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>', stroke: true },
                'default': { vb: '0 0 24 24', content: '<circle cx="12" cy="12" r="10" fill="currentColor"/>', stroke: false },
                'compulsory': { vb: '0 0 45 45', content: '<path d="M37.5,18.5l-3.3,3.3c-0.3,0.3-0.5,0.5-0.8,0.7v0.1c0,2.1-0.6,4.2-1.8,6c-1.2,1.8-2.9,3.2-4.9,4c-2,0.8-4.2,1-6.3,0.6c-2.1-0.4-4-1.5-5.6-3c-1.5-1.5-2.6-3.5-3-5.6c-0.4-2.1-0.2-4.3,0.6-6.3c0.8-2,2.2-3.7,4-4.9s3.9-1.8,6-1.8h0.1c0.2-0.3,0.4-0.6,0.7-0.8l3.3-3.3c-1.3-0.3-2.6-0.5-4-0.5C13.9,7,7,13.9,7,22.5S13.9,38,22.5,38S38,31.1,38,22.5C38,21.1,37.8,19.8,37.5,18.5z"/><path d="M17.8,16.3c-1.2,0.9-2.1,2.1-2.6,3.5c-0.5,1.4-0.6,2.9-0.3,4.3c0.3,1.4,1,2.8,2.1,3.8c1,1,2.4,1.8,3.8,2.1c1.4,0.3,2.9,0.2,4.3-0.3c1.4-0.5,2.6-1.4,3.5-2.6c0.9-1.2,1.4-2.6,1.6-4.1c-1.3,0-2.7,0.1-4,0L25.4,24c-0.3,0.3-0.6,0.5-1,0.7c-0.4,0.2-0.8,0.2-1.2,0.2c-0.4,0-0.8-0.1-1.2-0.2c-0.4-0.2-0.7-0.4-1-0.7c-0.3-0.3-0.5-0.6-0.7-1c-0.2-0.4-0.2-0.8-0.2-1.2c0-0.4,0.1-0.8,0.2-1.2c0.2-0.4,0.4-0.7,0.7-1l0.8-0.8c-0.1-1.3,0-2.7,0-4C20.4,14.9,19,15.4,17.8,16.3z"/><path d="M25.1,13.5C25,13.7,25,13.9,25,14.1v3.7l-2.8,2.8c-0.3,0.3-0.5,0.7-0.5,1.1s0.2,0.8,0.5,1.1c0.3,0.3,0.7,0.5,1.1,0.5c0.4,0,0.8-0.2,1.1-0.5l2.8-2.8h3.7c0.4,0,0.8-0.2,1.1-0.5l5.5-5.5c0.2-0.2,0.4-0.5,0.4-0.8c0.1-0.3,0-0.6-0.1-0.9c-0.1-0.3-0.3-0.5-0.6-0.7c-0.3-0.2-0.6-0.3-0.9-0.3h-2.8V8.6c0-0.3-0.1-0.6-0.3-0.9c-0.2-0.3-0.4-0.5-0.7-0.6v0C32.3,7.1,32,7,31.7,7.1c-0.3,0.1-0.6,0.2-0.8,0.4L25.4,13C25.3,13.2,25.2,13.3,25.1,13.5z"/>', stroke: false, fill: 'currentColor' },
                'elective': { vb: '0 0 45 45', content: '<path d="M35.9,9.1c-0.6-0.6-1.3-0.9-2.1-0.9H27c-0.8,0-1.5,0.3-2.1,0.9c-0.6,0.6-0.9,1.3-0.9,2.1V18c0,1.6,1.3,2.9,2.9,2.9h6.8c0.8,0,1.5-0.3,2.1-0.9c0.6-0.6,0.9-1.3,0.9-2.1v-6.8C36.8,10.4,36.4,9.7,35.9,9.1z"/><path d="M18,24.1h-6.8c-0.8,0-1.5,0.3-2.1,0.9c-0.6,0.6-0.9,1.3-0.9,2.1v6.8c0,1.6,1.3,2.9,2.9,2.9H18c0.8,0,1.5-0.3,2.1-0.9c0.6-0.6,0.9-1.3,0.9-2.1V27c0-0.8-0.3-1.5-0.9-2.1C19.5,24.4,18.8,24.1,18,24.1z"/><path d="M35.2,28.8H32v-3.2c0-0.4-0.2-0.8-0.5-1.1c-0.3-0.3-0.7-0.5-1.1-0.5s-0.8,0.2-1.1,0.5c-0.3,0.3-0.5,0.7-0.5,1.1v3.2h-3.2c-0.4,0-0.8,0.2-1.1,0.5c-0.3,0.3-0.5,0.7-0.5,1.1c0,0.4,0.2,0.8,0.5,1.1c0.3,0.3,0.7,0.5,1.1,0.5h3.2v3.2c0,0.4,0.2,0.8,0.5,1.1c0.3,0.3,0.7,0.5,1.1,0.5s0.8-0.2,1.1-0.5c0.3-0.3,0.5-0.7,0.5-1.1V32h3.2c0.4,0,0.8-0.2,1.1-0.5c0.3-0.3,0.5-0.7,0.5-1.1c0-0.4-0.2-0.8-0.5-1.1C36,29,35.6,28.8,35.2,28.8z"/><path d="M18,8.2h-6.8c-0.8,0-1.5,0.3-2.1,0.9c-0.6,0.6-0.9,1.3-0.9,2.1V18c0,1.6,1.3,2.9,2.9,2.9H18c0.8,0,1.5-0.3,2.1-0.9c0.6-0.6,0.9-1.3,0.9-2.1v-6.8c0-0.8-0.3-1.5-0.9-2.1C19.5,8.6,18.8,8.2,18,8.2z"/>', stroke: false, fill: 'currentColor' },
                'generalEducation': { vb: '0 0 45 45', content: '<path d="M20.3,7.7l-6.1,9.9c-0.7,1.1,0.1,2.5,1.4,2.5h12.1c1.3,0,2.1-1.4,1.4-2.5l-6.1-9.9c-0.1-0.2-0.3-0.4-0.6-0.6C22.2,7,22,6.9,21.7,6.9c-0.3,0-0.6,0.1-0.8,0.2C20.6,7.3,20.4,7.5,20.3,7.7z"/><path d="M30.7,38.1c4.1,0,7.3-3.3,7.3-7.3s-3.3-7.3-7.3-7.3s-7.3,3.3-7.3,7.3S26.6,38.1,30.7,38.1z"/><path d="M8.6,37.2h9.8c0.9,0,1.6-0.7,1.6-1.6v-9.8c0-0.9-0.7-1.6-1.6-1.6H8.6c-0.9,0-1.6,0.7-1.6,1.6v9.8C7,36.5,7.7,37.2,8.6,37.2z"/>', stroke: false, fill: 'currentColor' },
                'physicalEducation': { vb: '0 0 45 45', content: '<path d="M28.4,13.1c1.2,0,2.4-0.5,3.2-1.3c0.9-0.9,1.3-2,1.3-3.2c0-1.2-0.5-2.4-1.3-3.2c-0.9-0.9-2-1.3-3.2-1.3c-1.2,0-2.4,0.5-3.2,1.3c-0.9,0.9-1.3,2-1.3,3.2s0.5,2.4,1.3,3.2S27.2,13.1,28.4,13.1z"/><path d="M36.3,18.6c-0.2-0.6-0.7-1-1.2-1.2c-0.5-0.2-1-0.2-1.5-0.1l-0.2,0.1l0,0l-3.4,1.4l-2.7-3.9c-0.7-1.3-1.9-2.2-3.3-2.7c-0.2-0.1-0.5-0.1-0.7-0.1c-2.8-0.4-9.1,0.7-11.8,7.5l-0.1,0.3c-0.2,0.6-0.2,1.2,0.1,1.8c0.3,0.6,0.7,1,1.3,1.2c0.6,0.2,1.2,0.2,1.8-0.1c0.6-0.3,1-0.7,1.2-1.3c0.8-2,2-3.3,3.3-4l-1.7,4.3l0,0c0,0.1-0.1,0.2-0.1,0.3c-0.1,0.4-0.1,0.7-0.1,1.1c0.1,0.4,0.2,0.7,0.4,1v0l6.3,8.2l0.4,6.5v0c0,0.3,0.1,0.6,0.2,0.9c0.1,0.3,0.3,0.5,0.5,0.7c0.2,0.2,0.5,0.4,0.8,0.5c0.3,0.1,0.6,0.1,0.9,0.1c0.3,0,0.6-0.1,0.9-0.2c0.3-0.1,0.5-0.3,0.7-0.6c0.2-0.2,0.4-0.5,0.4-0.8c0.1-0.2,0.1-0.4,0.1-0.7l0-0.2l-0.5-7.8c0-0.1,0-0.1-0.1-0.2l0-0.1l-3.6-4.6l2-3.8c0.5,0.6,1.2,1,1.9,1.2c0.9,0.3,1.9,0.2,2.7-0.2l3.8-1.6v0l0,0c0.5-0.2,1-0.7,1.2-1.3C36.6,19.7,36.6,19.1,36.3,18.6z"/><path d="M18,25.8c-0.1-0.1-0.3-0.2-0.5-0.2c-0.2,0-0.3,0.1-0.4,0.3l0,0.1L15.8,30L11,29.7c-0.3,0-0.6,0-0.9,0.1c-0.3,0.1-0.6,0.2-0.8,0.4c-0.2,0.2-0.4,0.4-0.5,0.7c-0.1,0.3-0.2,0.6-0.2,0.9c0,0.3,0,0.6,0.1,0.9c0.1,0.3,0.2,0.6,0.4,0.8c0.2,0.2,0.4,0.4,0.7,0.5c0.3,0.1,0.6,0.2,0.9,0.2l5.2,0.4v0c0.9,0.1,1.8-0.2,2.6-0.7c0.8-0.5,1.3-1.2,1.6-2.1l0.7-2.1c0.1-0.2,0-0.3-0.1-0.5L18,25.8z"/>', stroke: false, fill: 'currentColor' },
                'cluster': { vb: '0 0 45 45', content: '<path d="M36.3,27.2c-0.2-0.1-0.4-0.2-0.6-0.4c-1.3,0.7-2.6,1.4-4,2c-3.4,1.6-6.2,2.4-7.7,2.7c-1,0.2-2.1,0.2-3.1,0c-1.4-0.3-4.2-1.1-7.7-2.7c-1.3-0.6-2.7-1.3-4-2c-0.2,0.1-0.4,0.3-0.6,0.4c-1.3,0.8-1.3,2.6,0,3.4c1.1,0.7,2.9,1.7,5.4,2.9c3.3,1.5,5.9,2.3,7.3,2.6c0.7,0.2,1.5,0.2,2.2,0c1.3-0.3,4-1,7.3-2.6c2.6-1.2,4.3-2.2,5.4-2.9C37.6,29.8,37.6,28.1,36.3,27.2z"/><path d="M8.7,24.2c1.1,0.7,2.9,1.7,5.4,2.9c3.3,1.5,5.9,2.3,7.3,2.6c0.7,0.2,1.5,0.2,2.2,0c1.3-0.3,4-1,7.3-2.6c2.6-1.2,4.3-2.2,5.4-2.9c1.3-0.8,1.3-2.6,0-3.4c-0.2-0.1-0.4-0.2-0.6-0.4c-1.3,0.7-2.6,1.4-4,2c-3.4,1.6-6.2,2.4-7.7,2.7c-1,0.2-2.1,0.2-3.1,0c-1.4-0.3-4.2-1.1-7.7-2.7c-1.3-0.6-2.7-1.3-4-2c-0.2,0.1-0.4,0.3-0.6,0.4C7.4,21.6,7.4,23.4,8.7,24.2z"/><path d="M8.7,17.8c1.1,0.7,2.9,1.7,5.4,2.9c3.3,1.5,5.9,2.3,7.3,2.6c0.7,0.2,1.5,0.2,2.2,0c1.3-0.3,4-1,7.3-2.6c2.6-1.2,4.3-2.2,5.4-2.9c1.3-0.8,1.3-2.6,0-3.4c-1.1-0.7-2.9-1.7-5.4-2.9c-3.3-1.5-5.9-2.3-7.3-2.6c-0.7-0.2-1.5-0.2-2.2,0c-1.3,0.3-4,1-7.3,2.6c-2.6,1.2-4.3,2.2-5.4,2.9C7.4,15.2,7.4,16.9,8.7,17.8z"/>', stroke: false, fill: 'currentColor' },
                'notCounted': { vb: '0 0 45 45', content: '<path fill="none" d="M32.6,20.7c-0.2-0.2-0.5-0.3-0.7-0.3H13.2c-0.3,0-0.5,0.1-0.7,0.3c-0.2,0.2-0.3,0.5-0.3,0.7v2.1c0,0.3,0.1,0.5,0.3,0.7c0.2,0.2,0.5,0.3,0.7,0.3h18.6c0.3,0,0.5-0.1,0.7-0.3c0.2-0.2,0.3-0.5,0.3-0.7v-2.1C32.9,21.2,32.7,20.9,32.6,20.7z"/><path fill="none" d="M32.6,20.7c-0.2-0.2-0.5-0.3-0.7-0.3H13.2c-0.3,0-0.5,0.1-0.7,0.3c-0.2,0.2-0.3,0.5-0.3,0.7v2.1c0,0.3,0.1,0.5,0.3,0.7c0.2,0.2,0.3,0.5,0.3,0.7v2.1C32.9,23.8,32.7,24.1,32.6,24.3z"/>', stroke: false, fill: 'currentColor' }
            }
        };

        const TabConfig = {
            MAIN_TABS: [
                { id: CONSTANTS.TAB_IDS.MAJOR, keys: [CONSTANTS.DEPT_KEYS.MAJOR], label: CONSTANTS.LABELS.TABS.MAJOR },
                { id: CONSTANTS.TAB_IDS.MIX, keys: [CONSTANTS.DEPT_KEYS.MAJOR, CONSTANTS.DEPT_KEYS.DOUBLE], label: CONSTANTS.LABELS.TABS.MIX },
                { id: CONSTANTS.TAB_IDS.DOUBLE, keys: [CONSTANTS.DEPT_KEYS.DOUBLE], label: CONSTANTS.LABELS.TABS.DOUBLE },
            ],
            MINOR_TABS: [
                { id: CONSTANTS.TAB_IDS.MINOR1, keys: [CONSTANTS.DEPT_KEYS.MINOR1], label: CONSTANTS.LABELS.TABS.MINOR1 },
                { id: CONSTANTS.TAB_IDS.MINOR2, keys: [CONSTANTS.DEPT_KEYS.MINOR2], label: CONSTANTS.LABELS.TABS.MINOR2 },
            ],
        };

        const resBody = {
            data: {
                name: "極限測試生",
                status: "未達畢業門檻",
                actualTotalCredits: 100,
                requiredTotalCredits: 128,
                messages: [
                    { title: "畢業審核說明", content: { type: 'text', text: "本儀表板試算結果僅供參考，實際畢業資格以註冊組審核為準。" } },
                    { content: { type: 'sub', text: "資料來源：教務處註冊組" } }
                ],
                programs: [
                    { type: "major", departmentName: "資訊科學系", year: 108 },
                    { type: "double", departmentName: "數位內容學位學程", year: 109 },
                    { type: "minor1", departmentName: "日本語文學系", year: 109 },
                    { type: "minor2", departmentName: "心理學系", year: 110, messages: [{ title: "備註", content: { type: 'text', text: "1111" } }] },
                ],
                categories: [
                    {
                        isSatisfied: false,
                        filterKey: ["major"],
                        groups: [
                            { order: 0, title: "通識", subtitle: "共同必修", icon: "generalEducation", progress: [{ label: "已修", value: "20", isRemain: false }, { label: "剩餘", value: "8", isRemain: false }] },
                            { order: 1, title: "中文通識 (3~6)", messages: [{ title: '選課提醒', content: { type: 'text', text: '需修滿6學分' } }], progress: [{ label: "已修", value: "6", isRemain: false }, { label: "剩餘額度", value: "0", isRemain: true }], courseList: [{ semester: "108-1", courseName: "現代文學", grade: "90", credits: "3.0" }, { semester: "108-2", courseName: "古典小說選讀與現代詮釋", grade: "88", credits: "3.0", note: "課名較長測試" }], progressSummary: "2 門已修課程" },
                            { order: 5, title: "核心通識", messages: [{ title: "修課說明", content: { type: 'text', text: "需修畢社會/自然核" } }], progress: [{ label: "已修", value: "0", isRemain: false }, { label: "剩餘", value: "0", unit: "門", isRemain: true }], progressNote: "已修畢社會 / 自然核" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["major", "double"],
                        groups: [
                            { order: 0, title: "體育", subtitle: "共同必修", icon: "physicalEducation", progress: [{ label: "已修", value: "4", isRemain: false }, { label: "剩餘", value: "0", isRemain: true }] },
                            { order: 1, title: undefined, courseList: [{ semester: "108-1", courseName: "籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級籃球初級", grade: "90", credits: "1.0" }, { semester: "108-2", badgeText: "必修", courseName: "游泳初級", grade: "88", credits: "1.0" }], progressSummary: "2 門已修課程" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["major"],
                        groups: [
                            { order: 0, title: "系訂必修", subtitle: "本系必修", icon: "compulsory", progress: [{ label: "已修", value: "45", isRemain: false }, { label: "剩餘", value: "12", isRemain: true }] },
                            { order: 1, title: "大一必修", progress: [{ label: "已修", value: "12", isRemain: false }], courseList: [{ semester: "108-1", courseName: "計算機概論", grade: "95", credits: "3.0" }], progressSummary: "已全數修畢" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["major"],
                        groups: [
                            { order: 0, title: "學程/模組", subtitle: "跨領域學習", icon: "cluster", progress: [{ label: "已修", value: "9", isRemain: false }, { label: "剩餘", value: "12", isRemain: true }] },
                            { order: 1, title: "創新模組", progress: [{ label: "已修", value: "9", isRemain: false }], courseList: [{ semester: "109-1", courseName: "設計思考", grade: "92", credits: "3.0" }, { semester: "109-2", courseName: "使用者體驗設計與研究方法", grade: "88", credits: "3.0", note: "Icon: Cluster 測試" }, { semester: "110-1", courseName: "服務創新", grade: "90", credits: "3.0" }], progressSummary: "3 門已修課程" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["double"],
                        groups: [
                            { order: 0, title: "雙主修必修", subtitle: "雙主修：數位內容", icon: "compulsory", progress: [{ label: "已修", value: "15", isRemain: false }, { label: "剩餘", value: "30", isRemain: true }] },
                            { order: 1, title: "核心課程", progress: [{ label: "已修", value: "9", isRemain: false }], courseList: [{ semester: "109-1", courseName: "數位內容導論", grade: "95", credits: "3.0" }], progressSummary: "1 門已修課程" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["minor1"],
                        groups: [
                            { order: 0, title: "輔系必修", subtitle: "輔系1：日本語文學系", icon: "compulsory", progress: [{ label: "已修", value: "10", isRemain: false }, { label: "剩餘", value: "10", isRemain: true }] },
                            { order: 1, title: "基礎日文", progress: [{ label: "已修", value: "4", isRemain: false }], courseList: [{ semester: "109-1", courseName: "初級日語(一)", grade: "92", credits: "2.0" }], progressSummary: "1 門已修課程" },
                        ]
                    },
                    {
                        isSatisfied: true,
                        filterKey: ["minor2"],
                        groups: [
                            { order: 0, title: "輔系選修", subtitle: "輔系2：心理學系", icon: "elective", progress: [{ label: "已修", value: "6", isRemain: false }, { label: "剩餘", value: "14", isRemain: true }] },
                            { order: 1, title: "心理選修", progress: [{ label: "已修", value: "6", isRemain: false }], courseList: [{ semester: "110-1", courseName: "普通心理學", grade: "88", credits: "3.0" }, { semester: "110-2", courseName: "社會心理學", grade: "92", credits: "3.0" }], progressSummary: "2 門已修課程" },
                        ]
                    },
                    {
                        isSatisfied: false,
                        filterKey: ["major"],
                        groups: [
                            { order: 0, title: "不計入畢業學分", subtitle: "其他", icon: "notCounted", progress: [{ label: "共計", value: "4", isRemain: false }] },
                            { order: 1, courseList: [{ semester: "108-1", badgeText: "棄修", courseName: "微積分(一)", grade: "0", credits: "0.0", note: "Icon: notCounted 測試" }, { semester: "108-2", badgeText: "體育選", courseName: "進階籃球", grade: "85", credits: "1.0", note: "超修體育不計入" }], progressSummary: "2 門課程" },
                        ]
                    },
                ],
            }
        };

        const AppIcon = {
            props: ['name', 'className'],
            template: `
                <svg :class="className" :viewBox="viewBox" :fill="fill" :stroke="useStroke ? 'currentColor' : 'none'" :stroke-width="useStroke ? 2 : 0" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" @click="$emit('click', $event)">
                    <g v-if="courseViewBox"><circle cx="12" cy="12" r="10"/></g>
                    <g v-else v-html="iconDef.content"></g>
                </svg>
            `,
            setup(props) {
                const courseViewBox = computed(() => ICONS.VIEWBOXES[props.name]);
                const iconDef = computed(() => ICONS.DEFS[props.name] || ICONS.DEFS['default']);
                const viewBox = computed(() => courseViewBox.value || iconDef.value.vb);
                const useStroke = computed(() => !courseViewBox.value && iconDef.value.stroke);
                const fill = computed(() => iconDef.value.fill || 'none');
                return { courseViewBox, iconDef, viewBox, useStroke, fill };
            }
        };

        const IconCheck = {
            template: `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            `
        };

        const NeumorphDonutChart = {
            props: ['actual', 'total'],
            template: `
                <svg viewBox="0 0 36 36" class="circular-chart transform overflow-visible">
                    <defs>
                        <filter id="neumorph-inner" x="-50%" y="-50%" width="200%" height="200%">
                            <feFlood flood-color="#a3b1c6" flood-opacity="0.6" result="flood1" />
                            <feComposite operator="out" in="flood1" in2="SourceAlpha" result="mask1" />
                            <feGaussianBlur in="mask1" stdDeviation="1" result="blur1" />
                            <feOffset dx="1" dy="1" in="blur1" result="offset1" />
                            <feComposite operator="in" in="offset1" in2="SourceAlpha" result="shadow1" />
                            <feFlood flood-color="#ffffff" flood-opacity="1" result="flood2" />
                            <feComposite operator="out" in="flood2" in2="SourceAlpha" result="mask2" />
                            <feGaussianBlur in="mask2" stdDeviation="1" result="blur2" />
                            <feOffset dx="-1" dy="-1" in="blur2" result="offset2" />
                            <feComposite operator="in" in="offset2" in2="SourceAlpha" result="shadow2" />
                            <feMerge>
                                <feMergeNode in="SourceGraphic" />
                                <feMergeNode in="shadow1" />
                                <feMergeNode in="shadow2" />
                            </feMerge>
                        </filter>
                        <filter id="neumorph-relief" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="1" result="blur" />
                            <feOffset in="blur" dx="1" dy="1" result="shadowOffset" />
                            <feComposite in="shadowOffset" in2="SourceAlpha" operator="in" result="shadowInner" />
                            <feColorMatrix in="shadowInner" type="matrix" values="0 0 0 0 0.35 0 0 0 0 0.42 0 0 0 0 0.55 0 0 0 0.4 0" result="shadowFinal" />
                            <feOffset in="blur" dx="-1" dy="-1" result="lightOffset" />
                            <feComposite in="lightOffset" in2="SourceAlpha" operator="in" result="lightInner" />
                            <feColorMatrix in="lightInner" type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.3 0" result="lightFinal" />
                            <feMerge>
                                <feMergeNode in="SourceGraphic" />
                                <feMergeNode in="shadowFinal" />
                                <feMergeNode in="lightFinal" />
                            </feMerge>
                        </filter>
                    </defs>
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#F3F4F6" stroke-width="5" filter="url(#neumorph-inner)"/>
                    <path class="circle" :stroke-dasharray="strokeDasharray" stroke="#7188B4" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke-width="3.8" filter="url(#neumorph-relief)" />
                </svg>
            `,
            setup(props) {
                const strokeDasharray = computed(() => `${(props.actual / props.total) * 100}, 100`);
                return { strokeDasharray };
            }
        };

        const TabButton = {
            props: ['isActive', 'label'],
            template: `
                <button 
                    class="px-5 py-2 rounded-full text-sm font-medium whitespace-nowrap flex items-center"
                    :class="isActive ? 'neumorph-btn-active' : 'neumorph-btn'"
                >
                    <div class="overflow-hidden transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)]"
                         :class="isActive ? 'max-w-[20px] opacity-100 mr-1.5' : 'max-w-0 opacity-0 mr-0'">
                         <slot name="icon"></slot>
                    </div>
                    <span>{{ label }}</span>
                </button>
            `
        };

        const TabNavigation = {
            props: [
                'shouldShowTabs', 
                'isSticky', 
                'availableMainTabs', 
                'availableMinorTabs', 
                'activeMainTab', 
                'activeMinors', 
                'isDoubleColumn', 
                'constants'
            ],
            emits: ['setMainTab', 'toggleMinorTab', 'toggleLayout', 'uploadFile'],
            components: { TabButton, AppIcon, IconCheck },
            setup(props, { emit }) {
                const tabRefs = ref({});
                const fileInput = ref(null);
                
                const setTabRef = (el, id) => {
                    if (el) tabRefs.value[id] = el.$el;
                };

                const triggerUpload = () => {
                    fileInput.value.click();
                };

                const onFileChange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    emit('uploadFile', file);
                    e.target.value = ''; // Reset input to allow re-uploading same file
                };

                watch(() => props.activeMainTab, (newId) => {
                     nextTick(() => {
                        if (tabRefs.value[newId]) {
                            tabRefs.value[newId].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }
                    });
                });

                return { tabRefs, setTabRef, fileInput, triggerUpload, onFileChange };
            },
            template: `
                <div v-if="shouldShowTabs"
                     class="sticky top-0 z-40 -mx-4 px-4 bg-[var(--c-bg)] transition-all duration-300"
                     :class="{ 'shadow-md': isSticky, 'shadow-none': !isSticky }">
                    <div class="pb-1 transition-all duration-300 pt-[1.75rem]" :class="isDoubleColumn ? 'md:pt-[2.75rem]' : ''">
                        <div class="text-xs font-bold text-sub">
                            {{ constants.LABELS.SELECT_GRADUATION }}
                        </div>
                        <div class="flex items-center gap-3 overflow-x-auto scrollbar-hide py-4 -mx-2 px-2">
                            <tab-button 
                                v-for="tab in availableMainTabs" 
                                :key="tab.id"
                                :ref="el => setTabRef(el, tab.id)"
                                :is-active="activeMainTab === tab.id"
                                :label="tab.label"
                                @click="$emit('setMainTab', tab.id)"
                            >
                                <template #icon><icon-check class="w-3.5 h-3.5 shrink-0"></icon-check></template>
                            </tab-button>
                            
                            <tab-button 
                                v-for="tab in availableMinorTabs" 
                                :key="tab.id"
                                :ref="el => setTabRef(el, tab.id)"
                                :is-active="activeMinors.includes(tab.id)"
                                :label="tab.label"
                                @click="$emit('toggleMinorTab', tab.id)"
                            >
                                <template #icon><span class="font-bold text-lg leading-none shrink-0 inline-block mr-0.5">+</span></template>
                            </tab-button>

                            <div class="w-px h-6 bg-gray-300 mx-2 flex-shrink-0"></div>
                            
                            <input type="file" ref="fileInput" class="hidden" accept=".json" @change="onFileChange">
                            <button
                                @click="triggerUpload"
                                class="neumorph-btn px-3 py-2 rounded-full flex items-center justify-center"
                                title="上傳 JSON"
                            >
                                <app-icon name="upload" class="w-5 h-5 text-sub"></app-icon>
                            </button>

                            <button
                                @click="$emit('toggleLayout')"
                                class="neumorph-btn px-3 py-2 rounded-full flex items-center justify-center"
                                :title="isDoubleColumn ? constants.LABELS.LAYOUT_TOOLTIP.TO_SINGLE : constants.LABELS.LAYOUT_TOOLTIP.TO_DOUBLE"
                            >
                                <app-icon :name="isDoubleColumn ? 'layout-list' : 'layout-grid'" class="w-5 h-5 text-sub"></app-icon>
                            </button>
                        </div>
                    </div>
                </div>
            `
        };

        const ProgressStats = {
            props: { progress: Array, size: { type: String, default: 'large' } },
            setup(props) {
                const sortedProgress = computed(() => props.progress ? [...props.progress].sort((a, b) => (!!a.isRemain - !!b.isRemain)) : []);
                const isSmall = computed(() => props.size === 'small');
                return { sortedProgress, isSmall };
            },
            template: `
                <div :class="isSmall ? 'flex items-baseline gap-3 text-sm' : 'flex items-center gap-6'">
                    <div v-for="(p, idx) in sortedProgress" :key="idx" 
                         :class="[
                            isSmall ? 'flex items-baseline gap-1' : 'flex items-baseline gap-2',
                            p.label === '已修完' ? 'bg-main text-inverse-main px-3 py-1 rounded-full' : ''
                         ]">
                        <div :class="[
                            isSmall ? 'text-xs' : 'text-base',
                            p.label === '已修完' ? 'text-inverse-main' : 'text-main'
                        ]">{{ p.label }}</div>
                        <div :class="[
                            isSmall ? 'font-bold' : 'text-4xl font-bold leading-none',
                            p.label === '已修完' ? 'text-inverse-main' : (p.isRemain ? 'text-primary' : 'text-main'),
                            isSmall && p.isRemain ? 'text-2xl' : '',
                            isSmall && !p.isRemain ? 'text-lg' : ''
                        ]">
                            {{ p.value }}
                        </div>
                        <div v-if="p.unit" :class="[
                            isSmall ? 'text-xs' : 'text-base',
                            p.label === '已修完' ? 'text-inverse-main' : 'text-main'
                        ]">{{ p.unit }}</div>
                    </div>
                </div>
            `
        };

        const ErrorOverlay = {
            props: ['errorInfo'],
            template: `
                <Teleport to="body">
                    <div v-if="errorInfo.hasError" class="fixed inset-0 z-[9999] backdrop-blur-sm bg-white/30 flex items-center justify-center">
                        <div class="bg-white/90 shadow-lg px-6 py-3 rounded-xl text-main font-bold flex flex-col items-center gap-2 border border-gray-100">
                            <div class="flex items-center gap-2">
                                <app-icon name="info" class="w-5 h-5 text-primary"></app-icon>
                                <span>{{ errorInfo.type === 'data' ? CONSTANTS.LABELS.MESSAGES.ERROR_DATA : CONSTANTS.LABELS.MESSAGES.ERROR_CONTACT }}</span>
                            </div>
                            <div v-if="errorInfo.type === 'system'" class="text-xs text-red-500 font-normal opacity-80 max-w-xs text-center break-all">{{ errorInfo.msg }}</div>
                        </div>
                    </div>
                </Teleport>
            `,
            components: { AppIcon },
            setup() { return { CONSTANTS } }
        };

        const DashboardHeader = {
            props: ['data'],
            emits: ['showInfo'],
            components: { AppIcon, ErrorOverlay, NeumorphDonutChart },
            setup(props) {
                const t = CONSTANTS.LABELS.DASHBOARD;
                const errorInfo = reactive({ hasError: false, type: '', msg: '' });

                watch(() => props.data, (newData) => {
                    try {
                        // Modified validation to check programs
                        if (!newData?.programs?.length) throw new Error("Initialization failed");
                    } catch (e) {
                        errorInfo.hasError = true;
                        errorInfo.type = 'system';
                        errorInfo.msg = e.message;
                    }
                }, { immediate: true });

                return { t, errorInfo };
            },
            template: `
                <div class="relative z-50">
                    <error-overlay :errorInfo="errorInfo"></error-overlay>
                    
                    <div class="p-6 flex flex-col items-center justify-center relative overflow-visible">
                        <div class="relative mb-2 filter drop-shadow-sm">
                            <div v-if="data?.status" class="relative">
                                <div class="px-4 py-2 bg-main text-inverse-main text-sm font-bold rounded-xl relative z-10">
                                    {{ data.status }}
                                </div>
                                <div class="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-4 h-4 bg-main rotate-45 z-0"></div>
                            </div>
                        </div>

                        <div class="flex items-center gap-6 mt-1">
                            <div class="relative w-24 h-24">
                                <neumorph-donut-chart :actual="data?.actualTotalCredits || 0" :total="data?.requiredTotalCredits || 100"></neumorph-donut-chart>
                            </div>
                            <div>
                                <div class="text-sub text-sm font-medium mb-1 flex items-center gap-1">
                                    {{ t.EARNED_CREDITS }}
                                    <app-icon v-if="data?.messages && data.messages.length" name="info" class="w-4 h-4 cursor-pointer text-sub hover:text-primary transition-colors" @click.stop="$emit('showInfo', data.messages)"></app-icon>
                                </div>
                                <div class="text-4xl font-bold text-main tracking-tight">
                                    {{ data?.actualTotalCredits || 0 }}
                                    <span class="text-lg text-sub font-normal">/ {{ data?.requiredTotalCredits || 0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        const CategoryHeader = {
            props: ['group', 'isOpen', 'showToggle', 'arrowClassName'],
            components: { AppIcon, ProgressStats },
            template: `
                <div class="flex justify-between items-center w-full">
                    <div class="flex gap-4">
                        <div class="w-12 h-12 flex items-center justify-center text-primary">
                            <app-icon :name="group.icon || 'generalEducation'" class="w-9 h-9"></app-icon>
                        </div>
                        <div class="flex flex-col justify-center">
                            <div class="text-xs font-medium mb-0.5 text-sub">{{ group.subtitle }}</div>
                            <div class="text-lg font-bold leading-none text-main">{{ group.title }}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex items-center gap-6">
                            <progress-stats v-if="group.progress" :progress="group.progress" size="large"></progress-stats>
                        </div>
                        <div :class="[
                            'flex items-center justify-center overflow-hidden transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)]',
                            showToggle ? 'w-6 ml-4 opacity-100 scale-100' : 'w-0 ml-0 opacity-0 scale-75',
                            arrowClassName ? arrowClassName : 'text-primary'
                        ]">
                            <app-icon :name="arrowClassName ? 'chevron-right' : (isOpen ? 'chevron-up' : 'chevron-down')" class="w-6 h-6 shrink-0"></app-icon>
                        </div>
                    </div>
                </div>
            `
        };

        const CourseListItem = {
            props: ['item'],
            template: `
                <div class="py-3 px-4 transition-colors grid grid-cols-[3.5rem_1fr_3rem_2rem] gap-x-2 gap-y-1 items-center text-sm">
                    <div class="whitespace-nowrap text-main font-medium">{{ item.semester }}</div>
                    <div class="flex items-center gap-2 min-w-0">
                        <span v-if="item.badgeText" class="px-1.5 py-[1px] text-[11px] rounded-full font-medium whitespace-nowrap shadow-sm bg-primary text-inverse-main">{{ item.badgeText }}</span>
                        <span class="font-medium text-main line-clamp-2 break-all">{{ item.courseName }}</span>
                    </div>
                    <div class="text-right text-main font-medium">{{ item.grade }}</div>
                    <div class="text-right font-medium text-main">{{ item.credits }}</div>
                    <div v-if="item.note" class="col-span-4 text-xs text-sub">{{ item.note }}</div>
                </div>
            `
        };

        const AccordionCard = {
            props: ['group', 'isOpen'],
            emits: ['toggle', 'showInfo'],
            components: { AppIcon, ProgressStats, CourseListItem },
            setup(props) {
                const contentRef = ref(null);
                const currentHeight = ref(props.isOpen ? 'auto' : '0px');
                
                watch(() => props.isOpen, (val) => {
                    const el = contentRef.value;
                    if (!el) return;

                    if (val) {
                        const height = el.scrollHeight;
                        currentHeight.value = `${height}px`;
                        setTimeout(() => {
                            if (props.isOpen) currentHeight.value = 'auto';
                        }, CONSTANTS.ANIMATION_DURATION);
                    } else {
                        const height = el.scrollHeight;
                        
                        currentHeight.value = `${height}px`;
                        
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                currentHeight.value = '0px';
                            });
                        });
                    }
                });

                return { contentRef, currentHeight };
            },
            template: `
                <div :class="(!group.title && !group.courseList?.length) ? '' : 'accordion-container overflow-hidden transition-all duration-300'">
                    <div v-if="group.title" @click="$emit('toggle')" class="p-4 cursor-pointer flex justify-between items-center h-full shadow-layer-header">
                        <div class="font-bold text-lg self-center text-main flex items-center gap-2">
                            <span>{{ group.title }}</span>
                            <app-icon v-if="group.messages && group.messages.length" name="info" class="w-4 h-4 cursor-pointer text-sub hover:text-primary transition-colors shrink-0" @click.stop="$emit('showInfo', group.messages)"></app-icon>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center gap-4">
                                <progress-stats v-if="group.progress" :progress="group.progress" size="small"></progress-stats>
                            </div>
                            <div v-if="group.progressNote" class="text-xs font-medium mt-1 text-primary">{{ group.progressNote }}</div>
                        </div>
                    </div>
                    
                    <div ref="contentRef" 
                         :style="{ height: currentHeight, transition: 'height 0.3s ease', overflow: 'hidden' }" 
                         :class="group.title ? 'shadow-layer-body' : 'shadow-layer-single'"
                         class="px-0">
                        <div v-if="group.courseList?.length > 0">
                            <template v-for="(item, idx) in group.courseList" :key="idx">
                                <div v-if="idx > 0" class="mx-4 border-t border-gray-200"></div>
                                <course-list-item :item="item"></course-list-item>
                            </template>
                        </div>
                        <div v-else-if="!group.title" class="border-t p-4 text-sm border-gray-200 text-sub">
                            {{ group.progressSummary }}
                        </div>
                    </div>
                    
                    <div v-if="group.title" @click="$emit('toggle')" class="p-3 cursor-pointer flex justify-between items-center text-xs transition-colors shadow-layer-footer text-sub">
                        <div class="font-medium text-sub"><span>{{ group.progressSummary }}</span></div>
                        <app-icon :name="isOpen ? 'chevron-up' : 'chevron-down'" class="w-4 h-4 text-sub"></app-icon>
                    </div>
                </div>
            `
        };

        const FooterInfo = {
            props: ['group'],
            emits: ['showInfo'],
            components: { AppIcon, ProgressStats },
            template: `
                <div class="flex justify-between items-center pt-0 pb-3 px-4">
                    <div class="flex items-center gap-2 font-bold">
                        <span class="text-lg text-main">{{ group.title }}</span>
                        <app-icon v-if="group.messages && group.messages.length" name="info" class="w-4 h-4 cursor-pointer text-sub hover:text-primary transition-colors" @click.stop="$emit('showInfo', group.messages)"></app-icon>
                    </div>
                    <div class="flex flex-col items-end">
                        <div v-if="group.progress" class="flex items-center gap-6">
                            <progress-stats :progress="group.progress" size="large"></progress-stats>
                        </div>
                        <div v-if="group.progressNote" class="text-xs font-medium mt-1 text-primary">{{ group.progressNote }}</div>
                    </div>
                </div>
            `
        };

        const CategoryContent = {
            props: ['category', 'categoryIndex', 'expandedAccordionKeys', 'isDualColumn'],
            emits: ['showInfo', 'toggleAccordion'],
            components: { AccordionCard, FooterInfo },
            setup(props) {
                const displayGroups = computed(() => {
                    const groups = props.category.groups.slice(1);
                    if (props.isDualColumn) {
                        const summaryGroups = [];
                        const courseGroups = [];
                        groups.forEach(group => {
                            if (!group.courseList && group.title) summaryGroups.push(group);
                            else courseGroups.push(group);
                        });
                        return [...summaryGroups, ...courseGroups];
                    }
                    return groups;
                });
                return { displayGroups, CONSTANTS };
            },
            template: `
                <div class="category-expand-inner px-0">
                    <div v-if="displayGroups.length > 0" class="flex flex-col gap-4">
                        <template v-for="(group) in displayGroups" :key="category.groups.indexOf(group)">
                            <footer-info 
                                v-if="!group.courseList && group.title" 
                                :group="group" 
                                @show-info="$emit('showInfo', $event)"
                            ></footer-info>
                            <accordion-card 
                                v-else
                                :group="group"
                                :is-open="!group.title || expandedAccordionKeys.has(categoryIndex + '-' + category.groups.indexOf(group))"
                                @toggle="$emit('toggleAccordion', categoryIndex, category.groups.indexOf(group))"
                                @show-info="$emit('showInfo', $event)"
                            ></accordion-card>
                        </template>
                    </div>
                    <div v-else class="py-8 text-center text-sm text-sub border border-dashed border-gray-300 rounded-lg">
                        {{ CONSTANTS.LABELS.MESSAGES.NO_DATA }}
                    </div>
                </div>
            `
        };

        const CategoryRenderer = {
            props: ['category', 'categoryIndex', 'isExpanded', 'expandedAccordionKeys'],
            emits: ['showInfo', 'toggle', 'toggleAccordion'],
            components: { CategoryHeader, CategoryContent },
            template: `
                <div class="flex flex-col transition-all duration-300" :class="category.isSatisfied ? 'neumorph-card-primary' : 'neumorph-card'">
                    <div class="p-6 cursor-pointer" @click="$emit('toggle')">
                        <category-header :group="category.groups[0]" :is-open="isExpanded" :show-toggle="true"></category-header>
                    </div>
                    <div class="category-expand-wrapper" :class="isExpanded ? 'open' : ''">
                        <div class="category-expand-inner px-6">
                            <div class="pt-2 pb-6">
                                <category-content 
                                    :category="category"
                                    :category-index="categoryIndex"
                                    :expanded-accordion-keys="expandedAccordionKeys"
                                    :is-dual-column="false"
                                    @show-info="$emit('showInfo', $event)"
                                    @toggle-accordion="(c, g) => $emit('toggleAccordion', c, g)"
                                ></category-content>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        const InfoModal = {
            props: ['show', 'messages'],
            emits: ['close'],
            components: { AppIcon },
            setup() { return { CONSTANTS } },
            template: `
                <Teleport to="body">
                    <transition name="modal">
                        <div v-if="show" class="fixed inset-0 z-[5000] flex justify-center items-end sm:pb-4 pointer-events-none">
                            <div 
                                class="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"
                                @click="$emit('close')"
                            ></div>
                            <div 
                                class="bg-white/95 shadow-xl border border-gray-100 rounded-2xl w-full max-w-lg mx-4 mb-4 p-6 relative z-10 pointer-events-auto flex flex-col gap-3 transition-transform duration-400 ease-[cubic-bezier(0.16,1,0.3,1)] translate-y-0"
                                @click.stop
                            >
                                <div class="flex items-center gap-2 text-primary">
                                    <app-icon name="info" class="w-6 h-6"></app-icon>
                                    <h3 class="text-lg font-bold text-main">{{ CONSTANTS.LABELS.MESSAGES.INFO_TITLE }}</h3>
                                </div>
                                <div class="flex flex-col gap-4 text-sm leading-relaxed max-h-[60vh] overflow-y-auto pr-2">
                                    <div v-for="(msg, idx) in messages" :key="idx">
                                        <div v-if="msg.title" class="font-bold text-main mb-1">{{ msg.title }}</div>
                                        <div :class="[
                                            'whitespace-pre-wrap',
                                            msg.content?.type === 'sub' ? 'text-sub text-xs' : 'text-main opacity-90'
                                        ]">{{ msg.content?.text || '' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </transition>
                </Teleport>
            `
        };

        const App = {
            components: {
                DashboardHeader, TabNavigation, TabButton, AppIcon, IconCheck,
                CategoryRenderer, CategoryHeader, CategoryContent, InfoModal
            },
            setup() {
                const data = ref(resBody.data);
                const activeMainTab = ref(CONSTANTS.TAB_IDS.MAJOR);
                const activeMinors = ref([]);
                const infoModal = reactive({ show: false, messages: [] });
                const selectedGlobalIndex = ref(0);
                const isDoubleColumn = ref(true);
                const expandedCategoryIndices = reactive(new Set());
                const expandedAccordionKeys = reactive(new Set());
                const isSticky = ref(false);
                const errorInfo = reactive({ hasError: false, type: '', msg: '' });
                
                const tabsRef = ref(null);
                const sentinelRef = ref(null);
                const tabRefs = ref({});

                const API_URL = 'https://graduation-check-demo.onrender.com/api/v1/check'; // TODO: 輸入指定的 URL

                onMounted(async () => {
                    const observer = new IntersectionObserver(
                        ([entry]) => {
                            isSticky.value = !entry.isIntersecting && entry.boundingClientRect.top < 0;
                        },
                        { threshold: 1, rootMargin: '-1px 0px 0px 0px' }
                    );
                    if (sentinelRef.value) observer.observe(sentinelRef.value);

                    // Fetch Logic
                    if (API_URL) {
                        try {
                            const res = await fetch(API_URL);
                            if (res.ok) {
                                const json = await res.json();
                                // 確保資料結構正確才覆蓋
                                if (json) {
                                    data.value = json.data;
                                }
                                // console.log(json);
                                // console.log(data.value);
                            }
                        } catch (e) {
                            console.warn('Fetch failed, using fallback data.');
                            // data.value is already resBody.data
                        }
                    }
                });

                const setTabRef = (el, id) => {
                    if (el) tabRefs.value[id] = el.$el;
                };

                const deptInfoMap = computed(() => {
                    // Changed departmentInfos to programs
                    return data.value.programs?.reduce((acc, d) => ({...acc, [d.type]: d}), {}) || {};
                });

                const isDeptOk = (t) => {
                    const info = deptInfoMap.value[t];
                    return info && !info.tags?.includes(CONSTANTS.TAGS.UNAVAILABLE);
                };

                const availableMainTabs = computed(() => {
                    return TabConfig.MAIN_TABS.filter(tab => {
                        if (tab.id === CONSTANTS.TAB_IDS.MAJOR) return true;
                        if (tab.id === CONSTANTS.TAB_IDS.MIX) return isDeptOk(CONSTANTS.DEPT_KEYS.DOUBLE);
                        if (tab.id === CONSTANTS.TAB_IDS.DOUBLE) return isDeptOk(CONSTANTS.DEPT_KEYS.DOUBLE) && !deptInfoMap.value[CONSTANTS.DEPT_KEYS.DOUBLE].tags?.includes(CONSTANTS.TAGS.DISABLED_SINGLE);
                        return false;
                    });
                });

                const availableMinorTabs = computed(() => {
                    return TabConfig.MINOR_TABS.filter(tab => isDeptOk(tab.id));
                });

                const shouldShowTabs = computed(() => availableMainTabs.value.length > 1 || availableMinorTabs.value.length > 0);

                const getFilterKeys = (mainTabId, minorIds) => {
                    const mainKeys = TabConfig.MAIN_TABS.find(t => t.id === mainTabId)?.keys || [];
                    const minorKeys = TabConfig.MINOR_TABS.filter(t => minorIds.includes(t.id)).flatMap(t => t.keys);
                    return new Set([...mainKeys, ...minorKeys]);
                };

                const activeFilterKeys = computed(() => getFilterKeys(activeMainTab.value, activeMinors.value));

                const isActiveCategory = (cat) => cat.filterKey?.some(k => activeFilterKeys.value.has(k));

                const filteredCategories = computed(() => {
                    return (data.value?.categories || []).filter(isActiveCategory);
                });

                const displayGlobalIndex = computed(() => {
                    const currentSelected = data.value.categories[selectedGlobalIndex.value];
                    if (currentSelected && isActiveCategory(currentSelected)) {
                        return selectedGlobalIndex.value;
                    }
                    if (filteredCategories.value.length > 0) {
                        return data.value.categories.indexOf(filteredCategories.value[0]);
                    }
                    return -1;
                });

                watch(displayGlobalIndex, (newVal) => {
                    if (newVal !== -1 && newVal !== selectedGlobalIndex.value) {
                        selectedGlobalIndex.value = newVal;
                    }
                });

                const getFirstValidIndex = (mainTabId, minorIds) => {
                    const validKeys = getFilterKeys(mainTabId, minorIds);
                    return data.value.categories.findIndex(cat => cat.filterKey?.some(k => validKeys.has(k)));
                };

                const toggleMinorTab = (id) => {
                    const prev = activeMinors.value;
                    const next = prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id];
                    activeMinors.value = next;
                    const idx = getFirstValidIndex(activeMainTab.value, next);
                    if (idx !== -1) selectedGlobalIndex.value = idx;
                };

                const setMainTab = (id) => {
                    activeMainTab.value = id;
                    const idx = getFirstValidIndex(id, activeMinors.value);
                    if (idx !== -1) selectedGlobalIndex.value = idx;
                    
                    // 滾動邏輯已移至 TabNavigation 處理
                };

                const openInfoModal = (msgs) => {
                    infoModal.show = true;
                    if (msgs && msgs.length > 0) {
                        infoModal.messages = msgs;
                    } else {
                        infoModal.messages = [{ title: "提示", content: { type: 'text', text: CONSTANTS.LABELS.MESSAGES.INFO_EMPTY } }];
                    }
                };

                const closeInfoModal = () => infoModal.show = false;

                const toggleCategoryExpansion = (originalIndex) => {
                    if (expandedCategoryIndices.has(originalIndex)) {
                        expandedCategoryIndices.delete(originalIndex);
                    } else {
                        expandedCategoryIndices.add(originalIndex);
                    }
                };

                const toggleAccordionExpansion = (categoryIndex, groupIndex) => {
                    const key = `${categoryIndex}-${groupIndex}`;
                    if (expandedAccordionKeys.has(key)) {
                        expandedAccordionKeys.delete(key);
                    } else {
                        expandedAccordionKeys.add(key);
                    }
                };

                const getOriginalIndex = (cat) => data.value.categories.indexOf(cat);
                const setSelectedGlobalIndex = (idx) => selectedGlobalIndex.value = idx;

                const handleFileUpload = (file) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const jsonContent = JSON.parse(e.target.result);
                            
                            const res = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(jsonContent)
                            });

                            if (!res.ok) throw new Error('API 請求失敗');
                            
                            const resJson = await res.json();
                            if (resJson.data) {
                                data.value = resJson.data;
                            } else {
                                throw new Error('回傳資料格式錯誤');
                            }
                        } catch (err) {
                            errorInfo.hasError = true;
                            errorInfo.type = 'system';
                            errorInfo.msg = '上傳失敗: ' + err.message;
                            // Auto hide error after 3 seconds
                            setTimeout(() => {
                                errorInfo.hasError = false;
                            }, 3000);
                        }
                    };
                    reader.readAsText(file);
                };

                return {
                    data, activeMainTab, activeMinors, infoModal, selectedGlobalIndex, isDoubleColumn,
                    expandedCategoryIndices, expandedAccordionKeys, isSticky, sentinelRef, tabsRef,
                    CONSTANTS, availableMainTabs, availableMinorTabs, shouldShowTabs, filteredCategories,
                    displayGlobalIndex, setMainTab, toggleMinorTab, openInfoModal, closeInfoModal,
                    toggleCategoryExpansion, toggleAccordionExpansion, getOriginalIndex, setSelectedGlobalIndex,
                    setTabRef, handleFileUpload, errorInfo
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>